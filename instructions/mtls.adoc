= Mutual TLS

Apply Mutual TLS to services in the cluster. 

:toc:

== What we will learn in this module
This module will provide instruction on how to enable Mutual TLS to secure communication
 between services in the mesh.

[IMPORTANT]
.Before Start
====
You should have only the following virtualservices and destinationrules in
the `istio-tutorial` namespace:

[source,bash,role="execute-1"]
----
oc -n istio-tutorial get destinationrule
oc -n istio-tutorial get virtualservice
----

And you should see something like the following:

----
No resources found.

NAME       GATEWAYS             HOSTS   AGE
customer   [customer-gateway]   [*]     18h
----
====

[#enablemtls]
== Enabling Mutual TLS
For this example, we will take advantage of another pod that is outside of
the service mesh. Let's grab that and the customer pod in a variable.

Examine the traffic between the curl and customer services and the preference service:

[source,bash,role="execute-2"]
----
bash <(curl -s https://raw.githubusercontent.com/kaovilai/istio-lab-summit-2019/homeroom/scripts/curl_customer_preference_quiet.sh)
----

Try running the load once in the upper terminal

[source,bash,role="execute-1"]
----
export CURL_POD=$(oc get pods -n istio-tutorial -l app=curl | grep curl | awk '{ print $1}' )
export CUSTOMER_POD=$(oc get pods -n istio-tutorial -l app=customer | grep customer | awk '{ print $1}' )
#"Executing curl in curl pod"
oc exec -n istio-tutorial $CURL_POD curl http://preference:8080
#"Executing curl in customer pod"
oc exec -n istio-tutorial $CUSTOMER_POD -c customer curl http://preference:8080
----

_Kialiâ€™s Graph_

Within the Kiali UI select the Graph option from the left hand navigation and
then choose:

* Namespace: istio-tutorial
* Versioned app graph
* Requests percentage
* Last 1m
* Every 10s
* Security checked under display

Notice that both requests were successful. In the Kiali graph, this can be
seen from the green line.

image::mtls_initial.png[]

Now configure preference to use mutual TLS policy. 

[source,bash,role="execute-1"]
----
oc -n istio-tutorial create -f https://raw.githubusercontent.com/thoraxe/istio-lab-summit-2019/master/src/istiofiles/authentication-enable-tls.yml
----

The Policy just created can be seen below:

[source, yaml]
----
apiVersion: "authentication.istio.io/v1alpha1"
kind: "Policy"
metadata:
  name: "preference-mutualtls"
  namespace: istio-tutorial
spec:
  targets:
  - name: preference
  peers:
  - mtls: 
      mode: STRICT
----

And try the curl again.

[source,bash,role="execute-2"]
----
bash <(curl -s https://raw.githubusercontent.com/kaovilai/istio-lab-summit-2019/homeroom/scripts/curl_customer_preference_quiet.sh)
----

Try running the load once in the upper terminal

[source,bash,role="execute-1"]
----
export CURL_POD=$(oc get pods -n istio-tutorial -l app=curl | grep curl | awk '{ print $1}' )
export CUSTOMER_POD=$(oc get pods -n istio-tutorial -l app=customer | grep customer | awk '{ print $1}' )
#"Executing curl in curl pod"
oc exec -n istio-tutorial $CURL_POD curl http://preference:8080
#"Executing curl in customer pod"
oc exec -n istio-tutorial $CUSTOMER_POD -c customer curl http://preference:8080
----

This time, we can see that the curl failed with exit code 56. This is because
preference is now requiring encrypted communication over mutual TLS, but
neither customer nor curl are using it.

We can see the same thing in Kiali. 

image::mtls_no_destination_rule.png[]

Stop the current curling in the lower terminal with Ctrl+C and create a destination rule to make communication to customer use mutual
TLS and run the curl again.

[source,bash,role="execute-1"]
----
oc -n istio-tutorial create -f https://raw.githubusercontent.com/thoraxe/istio-lab-summit-2019/master/src/istiofiles/destination-rule-tls.yml
----

The yaml just created can be seen below.

[source, yaml]
----
apiVersion: "networking.istio.io/v1alpha3"
kind: "DestinationRule"
metadata:
  name: "preference-destination-rule"
spec:
  host: "preference.istio-tutorial.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
----

Execute the curl script:

[source,bash,role="execute-2"]
----
bash <(curl -s https://raw.githubusercontent.com/kaovilai/istio-lab-summit-2019/homeroom/scripts/curl_customer_preference_quiet.sh)
----

Try running the load once in the upper terminal

[source,bash,role="execute-1"]
----
export CURL_POD=$(oc get pods -n istio-tutorial -l app=curl | grep curl | awk '{ print $1}' )
export CUSTOMER_POD=$(oc get pods -n istio-tutorial -l app=customer | grep customer | awk '{ print $1}' )
#"Executing curl in curl pod"
oc exec -n istio-tutorial $CURL_POD curl http://preference:8080
#"Executing curl in customer pod"
oc exec -n istio-tutorial $CUSTOMER_POD -c customer curl http://preference:8080
----

And again: exit code 56


This time, we can see that because customer is part of the mesh, the request
is successful. Since preference isn't, that still fails.

Looking at the Kiali graph, a lock is now present for communicationbetween
customer and preference, indicating that this communication is secured via
mTLS.

image::mtls_policy_and_rule.png[]

[#mtlsmigration]
== mTLS migration

Mutual TLS in OpenShift Service Mesh provides the ability to migrate to mTLS
gradually rather than forcing all services to migrate to mTLS at once. Lets
try that now.

First, delete the policy we created above.

[source,bash,role="execute-1"]
----
oc delete policy -n istio-tutorial preference-mutualtls
----

Now create a policy using permissive mode. 

[source,bash,role="execute-1"]
----
oc -n istio-tutorial create -f https://raw.githubusercontent.com/thoraxe/istio-lab-summit-2019/master/src/istiofiles/policy-permissive-tls.yml
----

The contents of the file are displayed below:

[source,yaml]
----
apiVersion: "authentication.istio.io/v1alpha1"
kind: "Policy"
metadata:
  name: "preference-mutualtls"
  namespace: istio-tutorial
spec:
  targets:
  - name: preference
  peers:
  - mtls: 
      mode: PERMISSIVE
----

If we try our curl commands again, we notice that this time they both pass:

[source,bash,role="execute-2"]
----
bash <(curl -s https://raw.githubusercontent.com/kaovilai/istio-lab-summit-2019/homeroom/scripts/curl_customer_preference_quiet.sh)
----

Try running the load once in the upper terminal

[source,bash,role="execute-1"]
----
export CURL_POD=$(oc get pods -n istio-tutorial -l app=curl | grep curl | awk '{ print $1}' )
export CUSTOMER_POD=$(oc get pods -n istio-tutorial -l app=customer | grep customer | awk '{ print $1}' )
#"Executing curl in curl pod"
oc exec -n istio-tutorial $CURL_POD curl http://preference:8080
#"Executing curl in customer pod"
oc exec -n istio-tutorial $CUSTOMER_POD -c customer curl http://preference:8080
----

In Kiali, we can see that the lock is still shown, indicating the presence of
mTLS. We see the curl pod labeled as unknown since it's not part of the mesh,
and we can see that both customer and curl are succesful.

image::mtls_permissive.png[]

[#cleanup]
== Cleanup

To cleanup, delete both the policy and destination rule that we created. 

[source,bash,role="execute-1"]
----
oc delete policy -n istio-tutorial preference-mutualtls
oc delete destinationrule -n istio-tutorial preference-destination-rule
----